<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwei.repository.mapper.RepositoryDuplicateMapper">

    <resultMap id="RepositoryDuplicate" type="com.iwei.repository.entity.RepositoryDuplicate">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <id column="rule_extract_id" property="ruleExtractId" jdbcType="INTEGER"/>
        <result column="repository_duplicate_name" property="repositoryDuplicateName" jdbcType="VARCHAR"/>
        <result column="api_url" property="apiUrl" jdbcType="VARCHAR"/>
        <result column="api_token" property="apiToken" jdbcType="VARCHAR"/>
        <result column="data_source" property="dataSource" jdbcType="INTEGER"/>
        <result property="createdBy" column="created_by" jdbcType="INTEGER"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="updatedBy" column="updated_by" jdbcType="INTEGER"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
        <result column="del_flg" property="delFlg" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="baseColumnList">
        id, rule_extract_id, repository_duplicate_name, api_url, api_token, data_source,
        created_by, created_at, updated_by, updated_at, del_flg
    </sql>

    <select id="queryById" resultMap="RepositoryDuplicate">
        SELECT <include refid="baseColumnList"/>
        FROM repository_duplicate
        WHERE id = #{id} AND del_flg = 0
    </select>

    <select id="selectList" resultMap="RepositoryDuplicate">
        SELECT <include refid="baseColumnList"/>
        FROM repository_duplicate
        WHERE del_flg = 0
        <if test="repositoryDuplicateName != null and repositoryDuplicateName != ''">
            AND repository_duplicate_name LIKE CONCAT('%', #{repositoryDuplicateName}, '%')
        </if>
        <if test="dataSource != null">
            AND data_source = #{dataSource}
        </if>
    </select>

    <select id="queryPageByCondition" resultMap="RepositoryDuplicate">
        SELECT
        <include refid="baseColumnList"/>
        FROM repository_duplicate
        <where>
            <if test="repositoryDuplicateVo.id != null">
                AND id = #{repositoryDuplicateVo.id}
            </if>
            <if test="repositoryDuplicateVo.repositoryDuplicateName != null and repositoryDuplicateVo.repositoryDuplicateName != ''">
                AND repository_duplicate_name LIKE CONCAT('%', #{repositoryDuplicateVo.repositoryDuplicateName}, '%')
            </if>
            <if test="repositoryDuplicateVo.apiUrl != null and repositoryDuplicateVo.apiUrl != ''">
                AND api_url LIKE CONCAT('%', #{repositoryDuplicateVo.apiUrl}, '%')
            </if>
            <if test="repositoryDuplicateVo.apiToken != null and repositoryDuplicateVo.apiToken != ''">
                AND api_token LIKE CONCAT('%', #{repositoryDuplicateVo.apiToken}, '%')
            </if>
            <if test="repositoryDuplicateVo.dataSource != null and repositoryDuplicateVo.dataSource != ''">
                AND data_source LIKE CONCAT('%', #{repositoryDuplicateVo.dataSource}, '%')
            </if>
            <if test="repositoryDuplicateVo.createdBy != null">
                AND created_by = #{repositoryDuplicateVo.createdBy}
            </if>
            <if test="repositoryDuplicateVo.createdAt != null">
                AND created_at = #{repositoryDuplicateVo.createdAt}
            </if>
            <if test="repositoryDuplicateVo.updatedBy != null">
                AND updated_by = #{repositoryDuplicateVo.updatedBy}
            </if>
            <if test="repositoryDuplicateVo.updatedAt != null">
                AND updated_at = #{repositoryDuplicateVo.updatedAt}
            </if>
            <if test="repositoryDuplicateVo.delFlg != null">
                AND del_flg = #{repositoryDuplicateVo.delFlg}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countByCondition" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM repository_duplicate
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="repositoryDuplicateName != null and repositoryDuplicateName != ''">
                AND repository_duplicate_name LIKE CONCAT('%', #{repositoryDuplicateName}, '%')
            </if>
            <if test="apiUrl != null and apiUrl != ''">
                AND api_url LIKE CONCAT('%', #{apiUrl}, '%')
            </if>
            <if test="apiToken != null and apiToken != ''">
                AND api_token LIKE CONCAT('%', #{apiToken}, '%')
            </if>
            <if test="dataSource != null and dataSource != ''">
                AND data_source LIKE CONCAT('%', #{dataSource}, '%')
            </if>
            <if test="createdBy != null">
                AND created_by = #{createdBy}
            </if>
            <if test="createdAt != null">
                AND created_at = #{createdAt}
            </if>
            <if test="updatedBy != null">
                AND updated_by = #{updatedBy}
            </if>
            <if test="updatedAt != null">
                AND updated_at = #{updatedAt}
            </if>
            <if test="delFlg != null">
                AND del_flg = #{delFlg}
            </if>
        </where>
    </select>

    <select id="queryDocByDuplicateId" resultType="com.iwei.repository.entity.RepositoryDoc">
        SELECT DISTINCT doc.id, doc.doc_name
        FROM repository_doc doc
                 INNER JOIN repository_duplicate_doc_mapping map
                            ON doc.id = map.repository_doc_id AND map.del_flg = 0
        WHERE map.repository_duplicate_id = #{repositoryDuplicateId}
          AND doc.del_flg = 0
    </select>

    <select id="queryIdAndName" resultMap="RepositoryDuplicate">
        SELECT id, repository_duplicate_name
        FROM repository_duplicate
        WHERE del_flg = 0
    </select>

    <select id="queryRuleByDuplicateId" resultType="com.iwei.rule.entity.RuleExtract">
        SELECT rule.rule_name, rule.elements
        FROM rule_extract rule
                 INNER JOIN repository_duplicate_extract_mapping map
                            ON rule.id = map.rule_extract_id
        WHERE map.repository_duplicate_id = #{duplicateId}
          AND rule.del_flg = 0
    </select>

    <select id="queryByPageAndRepoDupId" resultType="com.iwei.repository.entity.RepositoryDoc">
        SELECT doc.*
        FROM repository_doc doc
        INNER JOIN (
        SELECT DISTINCT doc.id, tdoc.duplicate_flg, tdoc.created_at
        FROM repository_doc doc
        INNER JOIN repository_duplicate_doc_mapping map
        ON doc.id = map.repository_doc_id
        INNER JOIN task_duplicate_doc tdoc
        ON doc.id = tdoc.repo_doc_id
        <where>
            <if test="duplicateFlg != null">
                AND tdoc.duplicate_flg = #{duplicateFlg}
            </if>
            <if test="projectCode != null and projectCode != ''">
                AND doc.project_code LIKE CONCAT('%', #{projectCode}, '%')
            </if>
            <if test="projectName != null and projectName != ''">
                AND doc.project_name LIKE CONCAT('%', #{projectName}, '%')
            </if>
            <if test="implOrg != null and implOrg != ''">
                AND doc.impl_org LIKE CONCAT('%', #{implOrg}, '%')
            </if>
            <if test="planYear != null and planYear != ''">
                AND doc.plan_year LIKE CONCAT('%', #{planYear}, '%')
            </if>
            <if test="projectMsg != null and projectMsg != ''">
                AND doc.project_msg LIKE CONCAT('%', #{projectMsg}, '%')
            </if>
            <if test="duplicateStatus != null">
                AND tdoc.task_status = #{duplicateStatus}
            </if>
        </where>
        AND tdoc.info_id = #{infoId}
        AND doc.del_flg = 0 AND map.del_flg = 0 AND tdoc.duplicate_flg != -1 AND tdoc.del_flg = 0
        ORDER BY tdoc.duplicate_flg DESC, tdoc.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
        ) AS unique_doc ON doc.id = unique_doc.id
        ORDER BY unique_doc.duplicate_flg DESC, unique_doc.created_at DESC
    </select>

    <select id="queryByPageAndRepoDupIdAndCondition" resultType="com.iwei.repository.entity.RepositoryDoc">
        SELECT doc.*
        FROM repository_doc doc
        INNER JOIN repository_duplicate_doc_mapping map
        ON doc.id = map.repository_doc_id
        <where>
            <if test="projectName != null and projectName != ''">
                AND doc.project_name LIKE CONCAT('%', #{projectName}, '%')
            </if>
        </where>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countByRepoDupId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM (
        SELECT DISTINCT doc.id
        FROM repository_doc doc
        INNER JOIN repository_duplicate_doc_mapping map
        ON doc.id = map.repository_doc_id
        INNER JOIN task_duplicate_doc tdoc
        ON doc.id = tdoc.repo_doc_id
        <where>
            <if test="duplicateFlg != null">
                AND tdoc.duplicate_flg = #{duplicateFlg}
            </if>
            <if test="projectCode != null and projectCode != ''">
                AND doc.project_code LIKE CONCAT('%', #{projectCode}, '%')
            </if>
            <if test="projectName != null and projectName != ''">
                AND doc.project_name LIKE CONCAT('%', #{projectName}, '%')
            </if>
            <if test="implOrg != null and implOrg != ''">
                AND doc.impl_org LIKE CONCAT('%', #{implOrg}, '%')
            </if>
            <if test="planYear != null and planYear != ''">
                AND doc.plan_year LIKE CONCAT('%', #{planYear}, '%')
            </if>
            <if test="projectMsg != null and projectMsg != ''">
                AND doc.project_msg LIKE CONCAT('%', #{projectMsg}, '%')
            </if>
            <if test="duplicateStatus != null">
                AND tdoc.task_status = #{duplicateStatus}
            </if>
        </where>
        AND tdoc.info_id = #{infoId}
        AND doc.del_flg = 0
        AND map.del_flg = 0
        AND tdoc.duplicate_flg != -1
        AND tdoc.del_flg = 0
        ) AS unique_doc
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO repository_duplicate (
            rule_extract_id, repository_duplicate_name, api_url, api_token, data_source,
            created_by, created_at, updated_by, updated_at, del_flg
        ) VALUES (
                     #{ruleExtractId}, #{repositoryDuplicateName}, #{apiUrl}, #{apiToken}, #{dataSource},
                     #{createdBy}, #{createdAt}, #{updatedBy}, #{updatedAt}, #{delFlg}
                 )
    </insert>

    <update id="updateById">
        UPDATE repository_duplicate
        <set>
            <if test="ruleExtractId != null">
                rule_extract_id = #{ruleExtractId},
            </if>
            <if test="repositoryDuplicateName != null and repositoryDuplicateName != ''">
                repository_duplicate_name = #{repositoryDuplicateName},
            </if>
            <if test="apiUrl != null and apiUrl != ''">
                api_url = #{apiUrl},
            </if>
            <if test="apiToken != null and apiToken != ''">
                api_token = #{apiToken},
            </if>
            <if test="dataSource != null">
                data_source = #{dataSource},
            </if>
            <if test="updatedBy != null">
                updated_by = #{updatedBy},
            </if>
            <if test="updatedAt != null">
                updated_at = #{updatedAt},
            </if>
            <if test="delFlg != null">
                del_flg = #{delFlg},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <update id="deleteById">
        UPDATE repository_duplicate SET del_flg = 1 WHERE id = #{id}
    </update>
</mapper>